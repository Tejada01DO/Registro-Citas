@page "/"

@inject IEmailService EmailService
@inject EmployeeBLL employeeBLL
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NotificationService Notify

@using Syncfusion.Blazor.Notifications
@using Syncfusion.Blazor.Schedule
@using System.Timers

<PageTitle>Index</PageTitle>



<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
        <title>Productos</title>
    </head>

    <body>
        <header>
            <div id="navbarHeader" class="collapse bg-dark">
                <div class="container">
                    <div class="row">
                        <div class="col-sm-8 col-md-7 py-4">
                            <h4 class="text-white">Sobre</h4>
                            <p class="alineado">Somos una empresa dedicada a brindarle a nuetros clientes las mejores experiencias de relajacion con los mejores productos del mercado, para convertirnos en una opcion confiable y recurrente para nuestros consumidores, tambien ofrecemos nuestros productos para el consumo individual, funcionando como suplidores y brindando servicios, como el cliente decida.</p>
                        </div>

                        <div class="col-sm-4 offset-md-1 py-4">
                            <h4 class="text-white">Contactos de Github</h4>
                            <ul class="list-unstyled">
                                <li><a href="https://github.com/Tejada01DO" class="text-white">Robert Tejada</a></li>
                                <li><a href="https://github.com/Vladimir-gs" class="text-white">Pedro Vladimir Guzman</a></li>
                                <li><a href="https://github.com/JeanRD7" class="text-white">Jean Luis de la Cruz</a></li>
                                <li><a href="https://github.com/Sebast1anHunter" class="text-white">Juan Sebastian Suarez</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="navbar navbar-dark bg-dark shadow-sm">
                <div class="container d-flex justify-content-between"><a class="navbar-brand d-flex align-items-center"</a>
                    <button class="btn navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarHeader" aria-controls="navbarHeader" aria-expanded="false" aria-label="Toggle navigation"><i class="fa fa-navicon"></i></button>
                </div>
            </div>
        </header>

        <main role="main">
            <section class="jumbotron text-center">
                <div class="container">
                    <h1>Productos</h1>
                    <p class="lead text-muted"><br>Descubre la esencia de la serenidad en nuestra tienda de productos de spa, donde cada producto está diseñado para renovar tu bienestar y llevar la experiencia de relajación a cada rincón de tu vida, porque creemos que mereces el lujo de cuidarte a ti mismo con productos que inspiran armonía y equilibrio.<br></p>
                </div>
            </section>

            <div class="album py-5 bg-light">
                <div class="container">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://assets.unileversolutions.com/v1/44022034.png" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">Esta crema para piel grasa es humectante y de uso diario. Ayuda a combatir la decoloración, reduciendo visiblemente la apariencia de manchas oscuras en 4 semanas, para que tu piel luzca radiante y con un tono más uniforme.<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>

                                        <medium class="oi oi-dollar">10</medium>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://hips.hearstapps.com/vader-prod.s3.amazonaws.com/1691762276-1442473.jpg?crop=1xw:1.00xh;center,top&resize=980:*" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">Hidrata la piel de forma rápida gracias a la combinación de ingredientes humectantes y aceite de almendras, que se activan cuando entran en contacto con el agua para absorberse al instante.<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>

                                        <medium class="oi oi-dollar">5</medium>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://www.cerave.es/-/media/Project/Loreal/BrandSites/CeraVe/Master/Spain/Product/Moisturizers/Moisturizing-cream-16oz.png" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">La Crema Hidratante de CeraVe, desarrollada por dermatólogos, ofrece una respuesta idónea para aquellas pieles sensibles y secas que buscan una hidratación profunda y duradera. Referente en las pieles más delicadas.<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>

                                        <medium class="oi oi-dollar">10</medium>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://www.aromesdemorella.com/1077-big_default/aceite-esencial-romero-aromaterapia-12-ml.jpg" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">El aceite esencial de Romero  es un aceite muy perfumado  en AROMATERAPÌA , es la CONCENTRACIÓN ,  crea ambientes frescos y aumenta la CONCENTRACIÓN y la MEMORIA .y su uso tópico como antiséptico.<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>

                                        <medium class="oi oi-dollar">5</medium>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://static.youngliving.com/productimages/large/45222.jpg" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">Celebra la época más mágica del año con el atrayente aroma de la naranja, la canela y la pícea negra. Usa la mezcla de aceites esenciales o disfruta de su fragancia en el jabón de manos.<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>

                                        <medium class="oi oi-dollar">15</medium>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://climed.com.do/wp-content/uploads/2021/09/Eucerin-Protector-Solar-en-Gel-Oil-control-SPF-50-X-50mL.jpg" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">El protector solar también es compatible con el mecanismo de reparación del ADN de la piel e incluye la tecnología Oil Control que regula el sebo.<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>

                                        <medium class="oi oi-dollar">8</medium>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://hips.hearstapps.com/vader-prod.s3.amazonaws.com/1662113053-n3-hair-perfector-reparador-y-fortalecedor-capilar.jpg?crop=1xw:1.00xh;center,top&resize=980:*" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">Se trata de una loción intensificadora para marcar aún tus rizos y conseguir acabar con el encrespamiento. Se aplica sobre el cabello mojado antes de empezar a trabajar en la definición.<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>

                                        <medium class="oi oi-dollar">5</medium>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://www.sofiablack.com/blog/wp-content/uploads/rulls-styling-curl-gel.webp" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">Si aún no conoces Rulls, solamente decirte que se incorporó al catálogo de la tienda este mismo año y ha sido todo un bombazo. Es Made in Spain y con ingredientes naturales ecológicos certificados. ¡Todo un descubrimiento!<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>
                                        
                                        <medium class="oi oi-dollar">15</medium>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card md-4 shadow-sm"><img class="bd-placeholder-img" width="100%" height="225" src="https://www.sofiablack.com/blog/wp-content/uploads/aunt-jackies-curl-la-la.webp" style="max-width: 100%; max-height: auto; height: auto;">
                                <div class="card-body">
                                    <p class="card-text">Una crema de peinado que lleva con nosotros desde los inicios de la tienda en 2012, y no deja de maravillar melenas rizadas de tipo 3 y 4. Rizos flexibles, suaves y superhidratados<br></p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div class="btn-group">
                                            <button type="button" class="btn btn-sm btn-outline-primary">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-success">Add to cart</button>
                                        </div>

                                        <medium class="oi oi-dollar">15</medium>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer class="text-muted">
            <div class="container">
                <br>
                <br>
            </div>
        </footer>
    </body>
</html>



<div class="control-container">
    <div class="toast-control">
        <h1>Agenda Una Cita</h1>
        <hr>
        <SfToast @ref="ToastRef" CssClass="e-schedule-reminder e-toast-info" NewestOnTop="true" ShowCloseButton="true" Target=".e-schedule" Timeout="10000">
            <ToastAnimationSettings>
                <ToastShowAnimationSettings Effect="ToastEffect.SlideRightIn"></ToastShowAnimationSettings>
                <ToastHideAnimationSettings Effect="ToastEffect.SlideRightOut"></ToastHideAnimationSettings>
            </ToastAnimationSettings>
            <ToastPosition X="Right" Y="Top"></ToastPosition>
            <ToastTemplates>
                <Template>
                    <div class="e-toast-template e-toast-info">
                        <div class="e-custom-toast">
                            <div class="e-toast-icon e-icons e-schedule-meeting-icon"></div>
                            <div class="e-avatar e-avatar-xsmall e-avatar-circle e-toast-avatar">
                                <img class="image" src="/images/status/@(EventData.EmployeeId).png" alt="avatar" />
                            </div>
                        </div>
                        <div class="e-toast-message">
                            <div class="e-toast-title">@EventData.Subject</div>
                            <div class="e-toast-content">@(EventData.StartTime.ToShortTimeString() + " - " + EventData.EndTime.ToShortTimeString())</div>
                        </div>
                    </div>
                </Template>
            </ToastTemplates>
            <ToastEvents Created="OnToastCreated"></ToastEvents>
        </SfToast>
    </div>
    <div class="schedule-control">
        <SfSchedule @ref="ScheduleRef" TValue="EventModel" Height="500px">
            <ScheduleGroup EnableCompactView="false" Resources="@GroupData"></ScheduleGroup>
            <ScheduleResources>
                <ScheduleResource TItem="Employee" TValue="int[]" DataSource="@employees" Field="EmployeeId" Title="Employee Name" Name="Employees" TextField="EmployeeName" IdField="EmployeeId" ColorField="EmployeeColor" AllowMultiple="true"></ScheduleResource>
            </ScheduleResources>
            <ScheduleEventSettings DataSource="@eventos"></ScheduleEventSettings>
            <ScheduleEvents TValue="EventModel" ActionCompleted="OnActionCompleted"></ScheduleEvents>
        </SfSchedule>
    </div>
    <br>
    <br>
</div>



<style>
    .e-toast .e-schedule-reminder .e-toast-template {
        display: flex;
    }

    .e-toast .e-schedule-reminder .e-custom-toast {
        display: inline-grid;
    }

    .e-toast .e-schedule-reminder .e-schedule-meeting-icon::before {
        content: "\e763";
        font-size: 20px;
    }

    .e-toast .e-schedule-reminder .e-toast-avatar {
        margin-top: 14px;
    }
</style>

@code{
    SfToast ToastRef;
    SfSchedule<EventModel> ScheduleRef;
    private string UserEmail;
    public Employee employee { get; set; } = new Employee(); 
    public string? email { get; set; }
    public List<Employee> employees { get; set; } = new List<Employee>(); 
    public List<EventModel> eventos { get; set; } = new List<EventModel>(); 
    
    protected override async void OnInitialized()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        email = user.Identity.Name;
        CortarHastaArroba(user.Identity.Name);
        UserEmail = CortarHastaArroba(user.Identity.Name);
        // Verifica si el usuario está autenticado y tiene el claim del correo electrónico
        if (user.Identity.IsAuthenticated)
        {
            var userEmailClaim = user.FindFirst(c => c.Type == "email");

            if (userEmailClaim != null)
            {
                UserEmail = CortarHastaArroba(user.Identity.Name);
            }
            else
            {
                // El claim de correo electrónico no está presente
                UserEmail = CortarHastaArroba(user.Identity.Name);
            }

            
            var employee = employeeBLL.Buscar(user.Identity.Name);
            CargarEventos();
            if(employee != null)
            {
                Notify.ShowNotification(
                titulo: "Bienvenido",
                mensaje: $"{UserEmail}",
                NotificationSeverity.Info);
                eventos = employee.Events;
                CargarEventos();
            }
            else
            {
                employeeBLL.Guardar(new Employee
                {
                    EmployeeEmail = user.Identity.Name,
                    EmployeeName = user.Identity.Name,
                    Events = new List<EventModel>()
                });

                Notify.ShowNotification(
                titulo: "Te has registrado",
                mensaje: $"Hola {UserEmail}",
                NotificationSeverity.Info);
                
            }
        }

        employees = employeeBLL.GetList(e => e.EmployeeEmail == email);
    }

    public EmailSettings emailSettings = new EmailSettings
    {
        DisplayName = "Syncfusion Scheduler",
        Username = "CorreoProyecto92@outlook.com",
        Password = "Cproyecto-92",
        Port = 587,
        Host = "smtp-mail.outlook.com"
    };

    public class ResourceModel
    {
        public string EmployeeName { get; set; }
        public int EmployeeId { get; set; }
        public string EmployeeColor { get; set; }
        public string EmployeeEmail { get; set; }
    }

    public EventModel EventData { get; set; }
    public string[] GroupData { get; set; } = new string[] { "Employees" };
    public List<ResourceModel> ResourceData { get; set; } = new List<ResourceModel> {
        new ResourceModel { EmployeeId = 1, EmployeeName = "Employee 1", EmployeeColor = "#EA7A57", EmployeeEmail = "xxxxxxxxxxxxxxx@outlook.com"  },
        new ResourceModel { EmployeeId = 2, EmployeeName = "Employee 2", EmployeeColor = "#357cd2", EmployeeEmail = "correop2463@gmail.com"  },
        new ResourceModel { EmployeeId = 3, EmployeeName = "Employee 3", EmployeeColor = "#7fa900", EmployeeEmail = "xxxxxxxxxxxxxxx@yahoo.com" }
    };
    //public List<EventModel> DataSource = eventos;

    private void OnToastCreated()
    {
        Timer timer = new Timer(60000);
        timer.Elapsed += new ElapsedEventHandler(async (object sender, ElapsedEventArgs e) =>
        {
            List<EventModel> eventDatas = ScheduleRef.GetCurrentViewEvents();
            int AlertBeforeMinutes = 5;
            DateTime CurrentTime = DateFormat(DateTime.Now);
            foreach (EventModel eventData in eventDatas)
            {
                DateTime StartTime = DateFormat(eventData.StartTime);
                if (DateTime.Compare(CurrentTime, StartTime.AddMinutes(-AlertBeforeMinutes)) == 0)
                {
                    EventData = eventData;
                    await InvokeAsync(async () => await ToastRef.ShowAsync());
                }
            }
        });
        timer.Enabled = true;
    }

    private DateTime DateFormat(DateTime date)
    {
        return new DateTime(date.Year, date.Month, date.Day, date.Hour, date.Minute, 0);
    }

    private static List<EventModel> GenerateEvents()
    {
        DateTime date1 = DateTime.Now;
        DateTime startDate = new DateTime(date1.Year, date1.Month, date1.Day, date1.Hour, date1.Minute, 0).AddMinutes(6);
        DateTime endDate = new DateTime(startDate.Ticks).AddHours(2);
        List<EventModel> collections = new List<EventModel>() {
            new EventModel { Id = 1, Subject = "Testing", StartTime = startDate, EndTime = endDate, EmployeeId = 1 },
            new EventModel { Id = 2, Subject = "Meeting", StartTime = startDate, EndTime = endDate, EmployeeId = 2 },
            new EventModel { Id = 3, Subject = "Conference", StartTime = startDate, EndTime = endDate, EmployeeId = 3 },
        };
        return collections;
    }

    private async void OnActionCompleted(ActionEventArgs<EventModel> args)
    {
        if (args.ActionType == ActionType.EventCreate || args.ActionType == ActionType.EventChange || args.ActionType == ActionType.EventRemove)
        {
            List<EventModel> added = args.AddedRecords ?? new List<EventModel>();
            List<EventModel> changed = args.ChangedRecords ?? new List<EventModel>();
            List<EventModel> deleted = args.DeletedRecords ?? new List<EventModel>();
            List<EventModel> datas = added.Concat(changed).Concat(deleted).ToList();
            List<string> toEmail = new List<string>();
            foreach (EventModel data in datas)
            {
                data.Id = 0;
                employee.Events.Add(data);
                string emails = email;
                if (EmailService.IsValidEmail(emails))
                {
                    toEmail.Add(emails);
                }
            }
            employeeBLL.Guardar(employee);
            toEmail = toEmail.Distinct().ToList();
            string Title = string.Empty;
            switch (args.ActionType)
            {
                case ActionType.EventCreate:
                    Title = "New Event Scheduled";
                    break;
                case ActionType.EventChange:
                    Title = "Scheduled Event Updated";
                    break;
                case ActionType.EventRemove:
                    Title = "Scheduled Event Removed";
                    break;
            }
            await EmailService.SendEmailAsync(toEmail, Title, datas[0]);
        }
    }

    public static string CortarHastaArroba(string input)
    {
        if (string.IsNullOrEmpty(input))
        {
            return input; // Devuelve la cadena original si es nula o vacía
        }

        int indiceArroba = input.IndexOf('@'); // Busca la posición del primer '@'

        if (indiceArroba != -1)
        {
            // Si se encuentra '@', devuelve la parte de la cadena antes del '@'
            return input.Substring(0, indiceArroba);
        }

        // Si no se encuentra '@', devuelve la cadena original
        return input;
    }

    public void CargarEventos()
    {
        eventos = employee.Events;
    }
}